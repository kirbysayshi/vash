(function(e){typeof define=="function"&&define.amd?define(e):typeof module=="object"&&module.exports?module.exports=e:window.vash=e})(function(e){function H(e){this.input=this.originalInput=e.replace(/\r\n|\r/g,"\n"),this.lineno=1,this.charno=0}function j(e,t){this.options=t||{},this.tokens=e,this.ast=B(F),this.prevTokens=[]}function U(e,t){this.ast=e,this.originalMarkup=t||""}var t=e;e.version="0.4.4-976",e.helpers={},e.config={useWith:!1,modelName:"model",helpersName:"html",htmlEscape:!0,debug:!1,debugParser:!1,debugCompiler:!1};var n="AT",r="ASSIGN_OPERATOR",i="AT_COLON",s="AT_STAR_CLOSE",o="AT_STAR_OPEN",u="BACKSLASH",a="BRACE_CLOSE",f="BRACE_OPEN",l="CONTENT",c="DOUBLE_QUOTE",h="EMAIL",p="FAT_ARROW",d="FUNCTION",v="HARD_PAREN_CLOSE",m="HARD_PAREN_OPEN",g="HTML_TAG_CLOSE",y="HTML_TAG_OPEN",b="HTML_TAG_SELFCLOSE",w="IDENTIFIER",E="KEYWORD",S="LOGICAL",x="NEWLINE",T="NUMERIC_CONTENT",N="OPERATOR",C="PAREN_CLOSE",k="PAREN_OPEN",L="PERIOD",A="SINGLE_QUOTE",O="TEXT_TAG_CLOSE",M="TEXT_TAG_OPEN",_="WHITESPACE",D={};D[o]=s,D[f]=a,D[c]=c,D[m]=v,D[k]=C,D[A]=A;var P=[h,/^([a-zA-Z0-9._%\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,4})\b/,o,/^(@\*)/,s,/^(\*@)/,i,/^@\:/,n,/^(@)/,p,/^(\(.*?\)?\s*?=>)/,k,/^(\()/,C,/^(\))/,m,/^(\[)/,v,/^(\])/,f,/^(\{)/,a,/^(\})/,M,/^(<text>)/,O,/^(<\/text>)/,b,/^(<[^@>]+?\/>)/,y,function(){return this.spewIf(this.scan(/^(<[^\/ >]+?[^>]*?>)/,y),"@")},g,/^(<\/[^>@\b]+?>)/,L,/^(\.)/,x,function(){var e=this.scan(/^(\n)/,x);return e&&(this.lineno++,this.charno=0),e},_,/^(\s)/,d,/^(function)(?![\d\w])/,E,/^(case|catch|do|else|finally|for|function|goto|if|instanceof|return|switch|try|typeof|var|while|with)(?![\d\w])/,w,/^([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)/,N,/^(===|!==|==|!==|>>>|<<|>>|>=|<=|>|<|\+|-|\/|\*|\^|%|\:|\?)/,r,/^(\|=|\^=|&=|>>>=|>>=|<<=|-=|\+=|%=|\/=|\*=|=)/,S,/^(&&|\|\||&|\||\^)/,u,/^(\\)/,c,/^(\")/,A,/^(\')/,T,/^([0-9]+)/,l,/^([^\s})@.]+?)/];H.prototype={scan:function(e,t){var n,r;if(n=e.exec(this.input))return this.input=this.input.substr(n[0].length),r={type:t,line:this.lineno,chr:this.charno,val:n[1],toString:function(){return"["+this.type+" ("+this.line+","+this.chr+"): "+this.val+"]"}},this.charno+=n[0].length,r},spewIf:function(e,t){var n,r;return e&&(n=e.val.split(t),n.length>1&&(e.val=n.shift(),r=t+n.join(t),this.input=r+this.input,this.charno-=r.length)),e},advance:function(){var e,t,n,r;for(e=0;e<P.length;e+=2){n=P[e+1],n.displayName=P[e],typeof n=="function"&&(r=n.call(this)),typeof n.exec=="function"&&(r=this.scan(n,P[e]));if(r)return r}}};var B=function(e){return new B.fn.init(e)};B.prototype.init=function(e){typeof e=="string"&&(this.mode=e),this.maxCheck()},B.fn=B.prototype.init.prototype=B.prototype,B.fn.vquery="yep",B.fn.constructor=B,B.fn.length=0,B.fn.parent=null,B.fn.mode=null,B.fn.tagName=null,B.fn.beget=function(e,t){var n=B(e);return n.parent=this,this.push(n),t&&(n.tagName=t),this.maxCheck(),n},B.fn.closest=function(e,t){var n=this;while(n){if(n.tagName===t||!n.parent)break;n=n.parent}return n},B.fn.pushFlatten=function(e){var t=e,n,r;while(t.length===1&&t[0].vquery)t=t[0];if(t.mode!==F)this.push(t);else for(n=0;n<t.length;n++)this.push(t[n]);return this.maxCheck(),this},B.fn.push=function(e){return B.isArray(e)?(e.vquery&&e.forEach(function(e){e.parent=this},this),Array.prototype.push.apply(this,e)):(e.vquery&&(e.parent=this),Array.prototype.push.call(this,e)),this.maxCheck(),this.length},B.fn.root=function(){var e=this;while(e&&e.parent&&(e=e.parent));return e},B.fn.toTreeString=function(){function n(r){var i,s;e.push(Array(t).join(" |")+" +"+r.mode+" "+(r.tagName||"")),t+=1,i=r.slice();while(s=i.shift())s.vquery===B.fn.vquery?n(s):e.push(Array(t).join(" |")+" "+(s?s.toString():"[empty]"));t-=1}var e=[],t=1;return n(this),e.join("\n")},B.fn.maxCheck=function(){if(this.length>=B.maxSize){var e=new Error;throw e.message="Maximum number of elements exceeded",e.name="vQueryDepthException",e}},B.maxSize=1e3,B.isArray=function(e){return Object.prototype.toString.call(e)=="[object Array]"},B.extend=function(e){var t,n,r;for(n=1;n<arguments.length;n++){t=arguments[n];for(r in t)e[r]=t[r]}return e},B.takeMethodsFromArray=function(){var e=["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice","indexOf","lastIndexOf","filter","forEach","every","map","some","reduce","reduceRight"],t=[],n;for(var r=0;r<e.length;r++){n=e[r];if(typeof t[n]!="function")throw new Error("Vash requires ES5 array iteration methods, missing: "+n);B.fn[n]||function(e){B.fn[e]=function(){return t[e].apply(this,Array.prototype.slice.call(arguments,0))}}(n)}},B.takeMethodsFromArray();var F="PROGRAM",I="MARKUP",q="BLOCK",R="EXPRESSION";j.prototype={parse:function(){var e,t,n,r;while(this.prevTokens.push(e),e=this.tokens.pop()){this.options.debugParser&&console.log(this.ast&&this.ast.mode,e.type,e,e.val);if(this.ast.mode===F||this.ast.mode===null)this.ast=this.ast.beget(this.options.initialMode||I),this.options.initialMode===R&&(this.ast=this.ast.beget(R));if(this.ast.mode===I){this.handleMKP(e);continue}if(this.ast.mode===q){this.handleBLK(e);continue}if(this.ast.mode===R){this.handleEXP(e);continue}}return this.ast=this.ast.root(),this.options.debugParser&&!this.options.initialMode&&(console.log(this.ast),console.log(this.ast.toTreeString())),this.ast},exceptionFactory:function(e,t,n){return t=="UNMATCHED"&&(e.name="UnmatchedCharacterError",this.ast=this.ast.root(),n&&(e.message="Unmatched "+n.type+" at line "+n.line+", character "+n.chr+". Value: "+n.val+"\n "+this.ast.toTreeString(),e.lineNumber=n.line)),e},advanceUntilNot:function(e){var t,n,r=[];while(n=this.tokens[this.tokens.length-1]){if(n.type!==e)break;t=this.tokens.pop(),r.push(t)}return r},advanceUntilMatched:function(e,t,n,r,i){var s=e,o=null,u=0,a=0,f=[];while(s){s.type===t?o&&o.type!==escape&&t!==n||!o?u++:t===n&&a++:s.type===n&&(a++,o&&o.type===i&&a--),f.push(s);if(u===a)break;o=s,s=this.tokens.pop();if(!s)throw this.exceptionFactory(new Error,"UNMATCHED",e)}return f.reverse()},subParse:function(e,t){var r,i,s,o=B.extend({},this.options);o.initialMode=t,r=this.advanceUntilMatched(e,e.type,D[e.type],null,n),r.pop(),i=r.shift(),this.ast.push(e),s=new j(r,o),s.parse(),this.ast.pushFlatten(s.ast),this.ast.push(i)},handleMKP:function(e){var t=this.tokens[this.tokens.length-1],r=this.tokens[this.tokens.length-2],i=null,u;switch(e.type){case o:this.advanceUntilMatched(e,o,s,n,n);break;case n:if(t)switch(t.type){case k:case w:this.ast.length===0&&(this.ast=this.ast.parent,this.ast.pop()),this.ast=this.ast.beget(R);break;case E:case d:case f:this.ast.length===0&&(this.ast=this.ast.parent,this.ast.pop()),this.ast=this.ast.beget(q);break;default:this.ast.push(this.tokens.pop())}break;case f:this.ast=this.ast.beget(q),this.tokens.push(e);break;case a:this.ast=this.ast.parent,this.tokens.push(e);break;case M:case y:i=e.val.match(/^<([^\/ >]+)/i),i===null&&t&&t.type===n&&r&&(i=r.val.match(/(.*)/)),this.ast.tagName?this.ast=this.ast.beget(I,i[1]):this.ast.tagName=i[1],y===e.type&&this.ast.push(e);break;case O:case g:i=e.val.match(/^<\/([^>]+)/i),i===null&&t&&t.type===n&&r&&(i=r.val.match(/(.*)/)),u=this.ast.closest(I,i[1]),u!==null&&u.tagName===i[1]&&(this.ast=u),g===e.type&&this.ast.push(e),this.ast.parent&&this.ast.parent.mode===q&&(t.type===_||t.type===x)&&(this.ast=this.ast.parent);break;case b:this.ast.push(e),this.ast.parent&&this.ast.parent.mode===q&&(t.type===_||t.type===x)&&(this.ast=this.ast.parent);break;default:this.ast.push(e)}},handleBLK:function(e){var t=this.tokens[this.tokens.length-1],r,s,o,u,a,l;switch(e.type){case n:t.type!==n&&(this.tokens.push(e),this.ast=this.ast.beget(I));break;case i:this.ast=this.ast.beget(I);break;case M:case O:case b:case y:case g:this.ast=this.ast.beget(I),this.tokens.push(e);break;case p:this.ast=this.ast.beget(q);break;case f:case k:this.subParse(e,q),o=this.advanceUntilNot(_),t=this.tokens[this.tokens.length-1],t&&t.type!==E&&t.type!==d&&t.type!==f&&e.type!==k?(this.tokens.push.apply(this.tokens,o.reverse()),this.ast=this.ast.parent):this.ast.push(o);break;case _:this.ast.push(e),this.advanceUntilNot(_);break;default:this.ast.push(e)}},handleEXP:function(e){var t=null,i,s,o,a,l,h,v;switch(e.type){case E:case d:this.ast=this.ast.beget(q),this.tokens.push(e);break;case _:case S:case r:case N:case T:this.ast.parent&&this.ast.parent.mode===R?this.ast.push(e):(this.ast=this.ast.parent,this.tokens.push(e));break;case w:this.ast.push(e);break;case A:case c:this.ast.parent&&this.ast.parent.mode===R?(l=this.advanceUntilMatched(e,e.type,D[e.type],u,u),this.ast.pushFlatten(l.reverse())):(this.ast=this.ast.parent,this.tokens.push(e));break;case m:case k:h=this.prevTokens[this.prevTokens.length-1],this.subParse(e,R),t=this.tokens[this.tokens.length-1];if(h&&h.type===n||t&&t.type===w)this.ast=this.ast.parent;break;case f:this.tokens.push(e),this.ast=this.ast.beget(q);break;case p:this.tokens.push(e),this.ast=this.ast.beget(q);break;case L:t=this.tokens[this.tokens.length-1],!t||t.type!==w&&t.type!==E&&t.type!==d&&t.type!==L?(this.ast=this.ast.parent,this.tokens.push(e)):this.ast.push(e);break;default:this.ast.parent&&this.ast.parent.mode!==R?(this.ast=this.ast.parent,this.tokens.push(e)):this.ast.push(e)}}};var z=U.prototype;z.assemble=function(e,t){function c(t){e.debug&&(n.push("__vl = "+t.line+", "),n.push("__vc = "+t.chr+"; \n"))}function h(e,t,r){c(e),n.push("MKP('"+e.val.replace(i,'"').replace(o,"\\n")+"')MKP")}function p(e,t,r){n.push(e.val.replace(i,'"'))}function d(t,r,o,u){var a="",f="",l=r.parent&&r.parent.mode!==R;e.htmlEscape!==!1&&(l&&o===0&&u&&(a+=e.helpersName+".escape("),l&&o===r.length-1&&u&&(f+=").toHtmlString() \n")),l&&o===0&&(c(t),a="__vo.push("+a),l&&o===r.length-1&&(f+="); \n"),n.push(a+t.val.replace(i,'"').replace(s,'"')+f),l&&o===r.length-1&&c(t)}function v(e){var t,n=e.slice(0),r,i,s;e.mode===R&&e.parent&&e.parent.mode!==R&&(r=e.filter(m).length);for(i=0;i<n.length;i++)s=n[i],s.vquery?v(s):e.mode===I?h(s,e,i):e.mode===q?p(s,e,i):e.mode===R&&d(s,e,i,r>0?!1:!0)}function m(e){return e.vquery&&e.mode===R?e.filter(m).length>0:e.vquery&&e.mode!==R?!0:!1}e=e||{},t=t||{};var n=[],r=[],i=/["']/gi,s=/(\\?)(["'])/gi,o=/[\n\r]/gi,u,a,f,l=[];n.push("var __vo = [], __vt; \n"),e.debug&&n.push("var __vl = 0, __vc = 0; \n"),v(this.ast),e.useWith===!0&&(n.unshift("with("+e.modelName+" || {}){ \n"),n.push("}")),e.debug&&(n.unshift("try { \n"),n.push("} catch(e){ (",z.reportError.toString(),")(e, __vl, __vc, ",'"'+this.originalMarkup.replace(o,"!LB!").replace(s,"\\$2")+'"',") } \n")),n.push("return __vo.join('');"),u=n.join(""),u=u.split("')MKPMKP('").join("").split("MKP(").join("__vo.push(").split(")MKP").join("); \n"),e.debugCompiler&&console.log(u);try{a=new Function(e.modelName,e.helpersName,u)}catch(g){throw g.message+=" -> "+u,g}return f=function(e){return a(e,t)},f.toString=function(){return a.toString()},f},z.reportError=function(e,t,n,r){var i=r.split("!LB!"),s=3,o=Math.max(0,t-s),u=Math.min(i.length,t+s),a=i.slice(o,u).map(function(e,n,r){var i=n+o+1;return(i===t?"  > ":"    ")+i+" | "+e}).join("\n");throw e.message="Problem while rendering template at line "+t+", character "+n+".\nOriginal message: "+e.message+"."+"\nContext: \n\n"+a+"\n\n",e},e.helpers.raw=function(e){var t=function(){return e};return e=e!=null?e:"",{toHtmlString:t,toString:t}};var W=/[&<>"'`]/g,X=function(e){return V[e]},V={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};return e.helpers.escape=function(e){var t=function(){return e};return e=e!=null?e:"",typeof e.toHtmlString!="function"?(e=e.toString().replace(W,X),{toHtmlString:t,toString:t}):e},e.VLexer=H,e.VParser=j,e.VCompiler=U,e.compile=function(n,r){if(n===""||typeof n!="string")throw new Error("Empty or non-string cannot be compiled");var i,s,o=[],u,a,f,l;r=B.extend({},e.config,r||{}),i=new H(n);while(s=i.advance())o.push(s);return o.reverse(),u=new j(o,r),u.parse(),a=new U(u.ast,n),f=a.assemble(r,e.helpers),f.displayName="render",f},e}({}))